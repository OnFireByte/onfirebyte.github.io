---
import Main from "@/components/Main.svelte";
import Layout from "@/layouts/Layout.astro";
import { Image } from "astro:assets";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
    const posts = await getCollection("blog");
    const allTags = posts.flatMap((post) => post.data.tags);
    const tags = [...new Set(allTags)];
    return tags.map((tag) => ({
        params: { slug: tag },
        props: {
            tag,
        },
    }));
}

const tag = Astro.props.tag;

const allBlogPosts = await getCollection("blog");
allBlogPosts.sort((a, b) => {
    return b.data.date.getTime() - a.data.date.getTime();
});

const blogPosts = allBlogPosts.filter((v) => v.data.tags.includes(tag));

function extractDesc(md: string) {
    const lines = md.trim().split("\n");

    let desc = "";
    for (const line of lines) {
        if (line.startsWith("#")) break;
        if (line.startsWith("```")) break;
        if (line.startsWith("---")) break;
        if (line == "") break;
        desc += line + "\n";
    }
    return desc;
}
---

<Layout title="Blog - pkpt">
    <Main class="flex justify-center flex-col">
        <h1 class="lg:text-8xl text-5xl font-bold my-4">Blog</h1>
        <h2 class="lg:text-3xl text-xl font-bold mb-12">#{tag}</h2>
        <div class="grid lg:grid-cols-2 gap-4">
            {
                blogPosts.map((v) => {
                    return (
                        <div
                            class="relative contents-fit group"
                            transition:name={`blog-card-${v.slug}`}
                        >
                            <div class="absolute bg-maindark w-full h-full z-[-10] rounded" />
                            <div class="bg-mainlight border-2 sm:h-52 border-maindark p-4 rounded flex flex-col-reverse sm:flex-row justify-between gap-4 transition-all ease-in-out group-hover:translate-y-[-0.75rem] group-hover:translate-x-[-0.75rem]">
                                <div class="flex flex-col justify-between gap-2">
                                    <p class="text-sm line-clamp-5">
                                        <a
                                            class="font-bold select-text text-lg block hover:underline underline-offset-4 decoration-wavy"
                                            transition:name={`title-${v.slug}`}
                                            href={`/blog/${v.slug}`}
                                        >
                                            {v.data.title}
                                        </a>
                                        {extractDesc(v.body)}
                                    </p>
                                    <div class="flex gap-2 text-sm overflow-hidden ">
                                        {v.data.tags.map((v) => (
                                            <a
                                                href={`/blog/tag/${v}`}
                                                class="rounded-full text-mainlight bg-maindark px-2 py-1"
                                            >
                                                {v}
                                            </a>
                                        ))}
                                    </div>
                                </div>
                                {v.data.cover && (
                                    <a href={`/blog/${v.slug}`} class="h-full lg:shrink">
                                        <Image
                                            src={v.data.cover}
                                            alt=""
                                            class={`aspect-[4/3] lg:aspect-auto object-cover rounded sm:min-w-[16rem] lg:min-w-[10rem] h-full w-full sm:w-auto border-2 border-maindark ${v.data.image_position}`}
                                            transition:name={`image-${v.slug}`}
                                        />
                                    </a>
                                )}
                            </div>
                        </div>
                    );
                })
            }
        </div>
    </Main>
</Layout>
